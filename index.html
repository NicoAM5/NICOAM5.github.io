<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Historia del Viento y Contaminaci√≥n del Aire en Chile</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500&display=swap" rel="stylesheet">
  <script src="https://d3js.org/d3.v6.min.js"></script>

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f5f7fa;
      margin: 0;
      padding: 20px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 5px;
    }

    .description {
      text-align: center;
      font-size: 18px;
      color: #555;
      margin-bottom: 30px;
    }

    #chart {
      margin-top: 40px;
      position: relative;
    }

    .tooltip {
      position: absolute;
      background-color: #333;
      color: #fff;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 12px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
    }

    footer {
      text-align: center;
      margin-top: 30px;
      color: #777;
    }

    .source-link {
      font-size: 12px;
      margin-top: 10px;
      color: #555;
    }

    .source-link a {
      color: #FF9800;
      text-decoration: none;
    }

    .source-link a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>

<div class="container">
  <h1>Historia de los Vientos y Cambio Clim√°tico en Santiago de Chile</h1>
  <p class="description">
    Intensidad de los vientos y su relaci√≥n con eventos hist√≥ricos relevantes entre 2010 y 2024.
  </p>

  <div id="chart"></div>
  <div class="tooltip" id="tooltip"></div>

  <div class="source-link">
    Fuente: <a href="https://www.meteochile.gob.cl/" target="_blank">Direcci√≥n Meteorol√≥gica de Chile</a>
    Estaci√≥n: 330019
  </div>

  <footer>
    <p>IIC2026 - Grupo 11 - 2024-2</p>
  </footer>
</div>

<script>
    // Configuraci√≥n inicial
    const width = 800;
    const height = 400;
    const margin = {top: 50, right: 50, bottom: 50, left: 50};

    // Crear SVG para el gr√°fico
    const svg = d3.select("#chart")
                  .append("svg")
                  .attr("width", width + margin.left + margin.right)
                  .attr("height", height + margin.top + margin.bottom);

    // Definir patr√≥n de fondo
    svg.append("defs")
       .append("pattern")
       .attr("id", "windPattern")
       .attr("width", 20)
       .attr("height", 20)
       .attr("patternUnits", "userSpaceOnUse")
       .append("text")
       .attr("x", 0)
       .attr("y", 15)
       .attr("font-size", "20px")
       .attr("fill", "rgba(0, 128, 0, 0.2)")
       .text("‚àº");
  
    // Agregar rect√°ngulo de fondo con el patr√≥n
    svg.append("rect")
       .attr("x", margin.left)
       .attr("y", margin.top)
       .attr("width", width)
       .attr("height", height)
       .attr("fill", "url(#windPattern)")
       .on("click", () => {
          // Reproducir el sonido de viento al hacer clic
          const audio = new Audio('wind_sound_wav');
          audio.play();
       });

    // Crear grupo de elementos para el gr√°fico
    const chartGroup = svg.append("g")
                          .attr("transform", `translate(${margin.left}, ${margin.top})`);

    // Crear el sonido fuera de la funci√≥n para evitar superposiciones
    const sonidoViento = new Audio("wind_sound.wav");
    let sonidoReproduciendo = false;

    // Crear √≠conos y texto en la esquina superior derecha de la visualizaci√≥n
    const instructionsGroup = svg.append("g")
                                 .attr("transform", `translate(${width + margin.left - 100}, ${margin.top - 10})`)
                                 .attr("fill", "rgba(0, 128, 0, 0.6)");
  
    instructionsGroup.append("text")
                     .attr("x", 0)
                     .attr("y", 20)
                     .attr("font-size", "18px")
                     .text("üîä");
  
    instructionsGroup.append("text")
                     .attr("x", 25)
                     .attr("y", 20)
                     .attr("font-size", "18px")
                     .text("üñ±Ô∏è");
  
    instructionsGroup.append("text")
                     .attr("x", 50)
                     .attr("y", 20)
                     .attr("font-size", "18px")
                     .text("click!");

    // L√≠nea de seguimiento vertical
    const trackingLine = chartGroup.append("line")
                                   .attr("stroke", "rgba(0, 128, 0, 0.4)")
                                   .attr("stroke-width", 1)
                                   .style("pointer-events", "none")
                                   .attr("y1", 0)
                                   .attr("y2", height)
                                   .attr("opacity", 0);

    // Cargar datos del CSV con punto y coma como delimitador
    d3.dsv(";", "vientos.csv").then(data => {
      data.forEach(d => {
        d.A√ëO = +d.A√ëO;
        d.INTENSIDAD = +d.INTENSIDAD.replace(' kt', '');
      });

      const x = d3.scaleLinear()
                  .domain(d3.extent(data, d => d.A√ëO))
                  .range([0, width]);

      const y = d3.scaleLinear()
                  .domain([0, d3.max(data, d => d.INTENSIDAD)])
                  .range([height, 0]);

      // Ejes
      chartGroup.append("g")
         .attr("transform", `translate(0,${height})`)
         .call(d3.axisBottom(x).ticks(data.length).tickFormat(d3.format("d")));

      chartGroup.append("g")
         .call(d3.axisLeft(y));

      // L√≠nea de viento
      chartGroup.append("path")
         .datum(data)
         .attr("fill", "none")
         .attr("stroke", "#FF9800")
         .attr("stroke-width", 2)
         .attr("d", d3.line()
                      .x(d => x(d.A√ëO))
                      .y(d => y(d.INTENSIDAD)));

      // Puntos de intensidad
      chartGroup.selectAll("circle")
         .data(data)
         .enter()
         .append("circle")
         .attr("cx", d => x(d.A√ëO))
         .attr("cy", d => y(d.INTENSIDAD))
         .attr("r", 6)
         .attr("fill", "#FF9800");

      // Configurar el evento de mousemove
      svg.on("mousemove", (event) => {
        const [mouseX] = d3.pointer(event);
        const chartX = mouseX - margin.left;

        if (chartX >= 0 && chartX <= width) {
          // Mostrar l√≠nea de seguimiento en la posici√≥n del mouse
          trackingLine.attr("x1", chartX)
                      .attr("x2", chartX)
                      .attr("opacity", 1);

          // Buscar el punto m√°s cercano en el eje Y
          const closestPoint = data.reduce((prev, curr) => {
            return Math.abs(x(curr.A√ëO) - chartX) < Math.abs(x(prev.A√ëO) - chartX) ? curr : prev;
          });

          // Ajustar el volumen en funci√≥n de la intensidad del punto m√°s cercano
          const volumen = Math.min(Math.max(closestPoint.INTENSIDAD / 50, 0), 20);
          sonidoViento.volume = volumen;

          // Reproducir sonido o ajustar volumen si ya est√° en reproducci√≥n
          if (!sonidoReproduciendo) {
            sonidoViento.play();
            sonidoReproduciendo = true;
          }
        } else {
          // Ocultar l√≠nea de seguimiento si el mouse sale del √°rea del gr√°fico
          trackingLine.attr("opacity", 0);
        }
      })
      .on("mouseout", () => {
        // Pausar y ocultar el sonido cuando el mouse sale del gr√°fico
        trackingLine.attr("opacity", 0);
        sonidoViento.pause();
        sonidoViento.currentTime = 0;
        sonidoReproduciendo = false;
      });

      // Hitos de contaminaci√≥n
      const hitos = [
        {year: 2011, description: 'Protestas estudiantiles'},
        {year: 2015, description: 'Declaraci√≥n de emergencia ambiental'},
        {year: 2020, description: 'Pandemia de COVID-19'},
        {year: 2024, description: 'Pol√≠ticas de reducci√≥n de emisiones'}
      ];

      chartGroup.selectAll(".hito-linea")
         .data(hitos)
         .enter()
         .append("line")
         .attr("x1", d => x(d.year))
         .attr("y1", y(0))
         .attr("x2", d => x(d.year))
         .attr("y2", y(d3.max(data, d => d.INTENSIDAD)))
         .attr("stroke", "#FF9800")
         .attr("stroke-dasharray", "4");

      chartGroup.selectAll(".hito-texto")
         .data(hitos)
         .enter()
         .append("text")
         .attr("x", d => x(d.year) + 5)
         .attr("y", y(0) - 10)
         .text(d => d.description)
         .attr("fill", "#333")
         .attr("font-size", "12px");


    });
</script>

</body>
</html>