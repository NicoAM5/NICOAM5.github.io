<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Historia del Viento y Contaminación del Aire en Chile</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500&display=swap" rel="stylesheet">
  <script src="https://d3js.org/d3.v6.min.js"></script>

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f5f7fa;
      margin: 0;
      padding: 20px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 5px;
    }

    .description {
      text-align: center;
      font-size: 18px;
      color: #555;
      margin-bottom: 30px;
    }

    #chart {
      margin-top: 40px;
      position: relative;
    }

    .tooltip {
      position: absolute;
      background-color: #333;
      color: #fff;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 12px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
    }

    footer {
      text-align: center;
      margin-top: 30px;
      color: #777;
    }

    .source-link {
      font-size: 12px;
      margin-top: 10px;
      color: #555;
    }

    .source-link a {
      color: #FF9800;
      text-decoration: none;
    }

    .source-link a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>

<div class="container">
  <h1>Historia de los Vientos y Cambio Climático en Santiago de Chile</h1>
  <p class="description">
    Intensidad de los vientos y su relación con eventos históricos relevantes entre 2010 y 2024.
  </p>

  <div id="chart"></div>
  <div class="tooltip" id="tooltip"></div>

  <div class="source-link">
    Fuente: <a href="https://www.meteochile.gob.cl/" target="_blank">Dirección Meteorológica de Chile</a>
    Estación: 330019
  </div>

  <footer>
    <p>IIC2026 - Grupo 11 - 2024-2</p>
  </footer>
</div>

<script>
  let currentAudio = null;  // Variable para el sonido actual
  let activeInfoBox = null; // Variable para la caja de información activa

  async function cargarCSV(ruta) {
      const response = await fetch(ruta);
      const data = await response.text();

      return data
          .trim()
          .split('\n')
          .slice(1)
          .map(line => {
              const [year, intensity, direction] = line.split(';');
              return {
                  year: parseInt(year),
                  intensity: parseInt(intensity.replace(' kt', '')),
                  direction: direction.trim()
              };
          });
  }

  async function dibujarGrafico() {
      const data = await cargarCSV('vientos.csv');
      const ctx = document.getElementById('windChart').getContext('2d');
      const labels = data.map(item => item.year);
      const intensities = data.map(item => item.intensity);

      const chart = new Chart(ctx, {
          type: 'line',
          data: {
              labels,
              datasets: [{
                  label: 'Intensidad promedio del Viento (kt)',
                  data: intensities,
                  borderColor: '#FF9800',
                  backgroundColor: 'rgba(255, 152, 0, 0.2)',
                  borderWidth: 2,
                  pointRadius: 6,
                  pointBackgroundColor: '#FF9800',
              }]
          },
          options: {
              responsive: true,
              plugins: {
                  legend: {
                      position: 'top',
                      labels: { font: { size: 14, weight: 'bold' } }
                  }
              },
              scales: {
                  y: {
                      beginAtZero: true,
                      max: 40,
                      title: { display: true, text: 'Intensidad (kt)', font: { size: 16, weight: 'bold' } }
                  },
                  x: {
                      title: { display: true, text: 'Año', font: { size: 16, weight: 'bold' } }
                  }
              },
              onClick: (event, elements) => {
                  if (elements.length > 0) {
                      const index = elements[0].index;
                      const year = labels[index];
                      const intensity = intensities[index];
                      showInfoBox(year, intensity, elements[0].element);
                  }
              }
          }
      });
  }

  function showInfoBox(year, intensity, pointElement) {
      // Cerrar cualquier infoBox existente
      if (activeInfoBox) {
          activeInfoBox.remove();
          activeInfoBox = null;
      }

      // Crear una nueva infoBox
      const infoBox = document.createElement('div');
      infoBox.className = 'info-box';
      infoBox.style.top = `${pointElement.y}px`;
      infoBox.style.left = `${pointElement.x}px`;
      infoBox.innerHTML = `
          <p><strong>Año:</strong> ${year}</p>
          <p><strong>Intensidad:</strong> ${intensity} kt</p>
          <button onclick="simulateWind(${intensity})">Simular viento</button>
      `;
      
      document.getElementById('chart-container').appendChild(infoBox);
      activeInfoBox = infoBox; // Actualizar la caja activa
  }

  function simulateWind(intensity) {
      const audio = new Audio('wind_sound.wav');
      const volume = Math.min(Math.max(intensity / 50, 0), 1);  // Ajuste de volumen
      audio.volume = volume;
      audio.loop = true;

      if (currentAudio) {
          currentAudio.pause();
          currentAudio.currentTime = 0;
      }

      audio.play();
      currentAudio = audio;

      // Cambia el botón a "Detener" al hacer clic para pausar la simulación
      document.querySelectorAll('button').forEach(btn => {
          btn.onclick = () => {
              if (audio.paused) {
                  audio.play();
                  btn.innerText = 'Detener simulación';
              } else {
                  audio.pause();
                  btn.innerText = 'Simular viento';
              }
          };
      });
  }

  dibujarGrafico();
</script>


</body>
</html>